#!/usr/bin/perl
use strict;
use warnings;
use LWP::UserAgent;
use Test::More;
use Test::WWW::Mechanize;

# These tests will assume you have a running GRCh38 server on port 8080
my $server = 'http://localhost:8080';
my $mech = Test::WWW::Mechanize->new;

my @positions = qw/left right either/;
sub find_ok {
    my ( $search_seq, $description, @expected ) = @_;
    my $all_ok = 1;
    foreach my $i ( 0 .. $#expected ) {
        $all_ok &&= $mech->post_ok("$server/find", { pam_right => $i, seq => $search_seq },
            "$description, search $positions[$i] => ok");
        $all_ok &&= $mech->content_is(join("\n", @{$expected[$i]}, ''), "$description, search $positions[$i] => content");
    }
    return $all_ok;
}

find_ok('TTACAAAAAAAAAAAGACAG', 'pams right', [], [qw/992310660 1106711039/], [qw/992310660 1106711039/]);
find_ok('TCACCTGAGTATTAAGCCCA', 'pams left',  [qw/974801065 1106711057/], [], [qw/974801065 1106711057/]);
my @mixed_left = qw/909587695 926402194 938675546 941235099 941743241 942286031 945327935 954585636 964414803 964486991 970008640 971038648 982284348 987189222 995894339 998277663 1000091869 1003822385 1024590601 1032114955 1039314984 1039581341 1050263114 1074595829 1075860319 1083102279 1109463511 1149728863 1186318110 1192000423 1193158312 1193227545 1193565666 1197284654/;
my @mixed_right = qw/957105133 1106711061 1175591472 1193893489/;
find_ok('CATGCATTAGCTATTTTTCC', 'pams either', \@mixed_left, \@mixed_right, [sort { $a <=> $b } @mixed_left, @mixed_right]);

$mech->post_ok("$server/find", { pam_right => 2, seq => 'GCACTTTGGGAGGCCAAGGC' }, "doesn't crash when finding a huge list");

$mech->post("$server/find", { seq => 'GCACTTTGGGAGGCCAAGGC' });
ok !$mech->success, 'find without pam_right => not ok';
$mech->content_is('Invalid query', 'find without pam_right => error');

$mech->post("$server/find", { pam_right => '20', seq => 'GCACTTTGGGAGGCCAAGGC' });
ok !$mech->success, 'find with invalid pam_right => not ok';
$mech->content_is('Invalid query', 'find with invalid pam_right => error');

$mech->post("$server/find", { pam_right => '2', seq => 'GCATTTGGGAGGCCAAGGC' });
ok !$mech->success, 'find with incorrect sequence length => not ok';
$mech->content_is('Invalid query', 'find with incorrect sequence length => error');

my $expected = do { local $/; <DATA> };
$expected =~ s/\\t/\t/g;
$mech->post("$server/search", content => join("\n", qw/1106711227 1106710986 1106711054 1106711049 GCTTTAGGTTCATTGGAATC AATGATACTGATCCATTAGA GTTCCTGCATTAGTTTGCTT TGCAGGGACACAGATGGAGC/));
ok $mech->success, 'search off targets => ok';
$mech->content_is($expected, 'search off targets => content');

$mech->post("$server/search", content => 'fred');
ok !$mech->success, 'invalid off-target search => not ok';
$mech->content_is('Invalid sequence', 'invalid off-target search => error');

done_testing;

__DATA__
1106711227\t4\t{909382362,912111752,913675758,914027656,916440004,918860415,919987029,920463126,923231035,926540366,931035616,940070959,943267127,948002290,954347562,957179065,959460200,971886088,974989324,980960838,981617431,987254051,987521857,993244045,996918621,1013707016,1017252303,1017317740,1020989074,1022076808,1023755139,1027691796,1027956857,1032797108,1033598916,1041195843,1041521312,1048047515,1048435680,1051160516,1055873939,1056012949,1060375636,1063548516,1081241995,1091115356,1093489226,1093592197,1102406425,1106711227,1127041236,1128589889,1128864304,1130417934,1131298609,1133872766,1134282626,1135147808,1136153802,1136209289,1182946632,1196501644}\t{0: 1, 1: 0, 2: 0, 3: 6, 4: 55}
1106710986\t4\t{901573582,904802269,908474288,918582729,920717881,924621938,925931709,932808745,943535884,951004118,953963844,960389643,964508551,965128266,966220670,971431581,978511112,980845731,989478022,1005422027,1016677983,1021658988,1024682872,1026177632,1034193674,1040452267,1049995084,1055252605,1056816253,1071832836,1073839202,1078334332,1080427196,1081902795,1089837431,1095137234,1096865713,1100544895,1101219704,1106710986,1109764668,1112045223,1126115076,1126946331,1128628555,1146809297,1151475420,1151752012,1158470147,1160840321,1166962913,1169393575,1178569964,1189078675,1195713368,1202170596,1202220768,1202322345,1202548425}\t{0: 1, 1: 0, 2: 0, 3: 2, 4: 56}
1106711054\t4\t\N\t{0: 18, 1: 585, 2: 5778, 3: 18773, 4: 13857}
1106711049\t4\t\N\t{0: 1, 1: 2, 2: 122, 3: 1449, 4: 3321}
GCTTTAGGTTCATTGGAATC\t4\t{901892684,907709001,908736433,918385320,919504513,919851483,926660796,926851390,931166749,935132295,943430999,944622656,948009751,949949745,961340948,963630618,964517030,967788433,977653762,979718728,979947057,980228249,987161066,989806159,991004839,995967520,997280001,997733820,1002194983,1003806781,1008846656,1011019444,1013036957,1013772814,1018266276,1018520911,1029834406,1031751719,1032152716,1032716880,1041389568,1046586305,1049150443,1050685450,1053712925,1055689090,1056457804,1062418440,1063649229,1064502504,1065719985,1067053561,1068009092,1076596801,1088351879,1091128027,1093113103,1093625036,1094692194,1098933512,1100953305,1106710952,1107627048,1108698701,1113102015,1114377056,1115094251,1123441818,1125761353,1126218621,1135083301,1135140466,1136842743,1146758376,1146912870,1155139022,1157519202,1164866575,1165677069,1186677810,1203152908}\t{0: 1, 1: 0, 2: 1, 3: 3, 4: 76}
AATGATACTGATCCATTAGA\t4\t{905988533,906131376,906844816,907866391,908647089,910527012,910820343,912028764,917867040,919965399,921823815,926055232,927001162,928988938,931000191,931330057,935856818,936169113,939589890,942424520,950407545,951884651,955424387,956140533,957238989,962230775,962294494,962577140,963578215,965779077,966821652,967128301,967399416,970506037,970736281,971537103,971614919,971622665,973796872,974964762,976901371,979058440,980050347,980985026,982395364,983841831,985230769,985376050,986143952,988400201,988786017,988938089,990687524,990704195,991630320,991912582,991948863,992407000,992633567,996139725,996620902,996640691,996795856,999056719,999197422,999615450,1000706981,1001901948,1003729014,1005399802,1010588847,1020602203,1021286265,1022590688,1022756581,1023604217,1024020913,1024916934,1027678816,1027771635,1027974155,1031736286,1033381048,1036273008,1036348340,1036843610,1036864984,1039379095,1042704210,1043832525,1044039798,1048353623,1051994339,1052353571,1056049193,1056062872,1057615509,1058571335,1059077458,1059643886,1060609021,1065491275,1065945212,1078589324,1079930006,1080842237,1083353985,1085557004,1087940258,1087942454,1088606315,1089264427,1090351528,1091371195,1092215152,1094564604,1100571896,1101616966,1104528940,1105710166,1109416052,1111099180,1112096880,1112827866,1116177165,1116769842,1117018769,1118447564,1124922937,1126516357,1131780424,1131932428,1137786639,1138039706,1138794270,1140464235,1143749454,1147738488,1150457112,1150895928,1151055002,1155846162,1157554585,1161578009,1168576576,1171474299,1174691490,1177814765,1178458877,1180783063,1180943034,1181126626,1181239961,1187124044,1187269159,1187850698,1192159839,1192164428,1192684602,1192684868,1192901267,1195599736,1196484508,1196937968,1198954427,1201066724,1201799638,1201801915,1202336827,1202361905,1202363168,1202507611,1202508873,1202533938}\t{0: 0, 1: 0, 2: 0, 3: 8, 4: 166}
GTTCCTGCATTAGTTTGCTT\t4\t\N\t{0: 117, 1: 1681, 2: 2821, 3: 5461, 4: 5344}
TGCAGGGACACAGATGGAGC\t4\t\N\t{0: 19, 1: 263, 2: 2003, 3: 9495, 4: 16568}
